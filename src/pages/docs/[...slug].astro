---
import DocsLayout from "../../layouts/DocsLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const docs = await getCollection("docsPublic");
  return docs.map((doc) => ({
    params: { slug: doc.slug },
  }));
}

const slug = Astro.params.slug ?? "";
const docs = (await getCollection("docsPublic")).sort((a, b) => {
  if (a.data.section === b.data.section) {
    return a.data.order - b.data.order || a.data.title.localeCompare(b.data.title);
  }
  return a.data.section.localeCompare(b.data.section);
});

const doc = docs.find((entry) => entry.slug === slug);

if (!doc) {
  return Astro.redirect("/docs", 302);
}

const sections = docs.reduce<Record<string, typeof docs>>((acc, entry) => {
  const section = entry.data.section ?? "General";
  if (!acc[section]) acc[section] = [];
  acc[section].push(entry);
  return acc;
}, {});

const pageTitle = `${doc.data.title} | Docs | Greenlight Approvals`;
const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).href : `/docs/${slug}`;
const { Content } = await doc.render();
const { data } = doc;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{pageTitle}</title>
    <meta name="description" content={data.description ?? "Greenlight Approvals documentation."} />
    <link rel="canonical" href={canonical} />
    <link rel="icon" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;family=Inter:wght@400;500;600&amp;display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <DocsLayout
      title={data.title}
      description={data.description}
      badge="Public docs"
      searchItems={docs.map((entry) => ({
        title: entry.data.title,
        description: entry.data.description,
        section: entry.data.section,
        slug: entry.slug,
      }))}
      searchBase="/docs"
    >
      <nav slot="sidebar" class="docs-nav">
        {Object.entries(sections).map(([section, items]) => (
          <div class="docs-group">
            <p class="docs-group__label">{section}</p>
            <ul>
              {items.map((item) => (
                <li>
                  <a class={item.slug === doc.slug ? "is-active" : ""} href={`/docs/${item.slug}`}>
                    {item.data.title}
                  </a>
                  {item.data.description && <small>{item.data.description}</small>}
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>

      <Content />
    </DocsLayout>
  </body>
</html>
